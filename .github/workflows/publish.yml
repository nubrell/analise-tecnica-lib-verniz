name: Publish Packages

on:
  push:
    tags:
      - 'v*'  # Publica quando uma tag versÃ£o Ã© criada (ex: v1.0.0)
  workflow_dispatch: # Permite disparar manualmente

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish:
    name: Build and Publish Packages
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@nubrell'

      - name: Install Dependencies
        working-directory: lib-verniz-starter
        run: yarn install --frozen-lockfile

      - name: Build @nubrell Packages
        working-directory: lib-verniz-starter
        run: |
          echo "Building @nubrell packages..."
          
          # Build utils
          if [ -d "packages/utils" ] && [ -f "packages/utils/package.json" ]; then
            package_name=$(grep -o '"name": "[^"]*"' packages/utils/package.json | cut -d'"' -f4)
            if [[ "$package_name" == @nubrell/* ]]; then
              echo "Building $package_name..."
              cd packages/utils
              yarn build
              cd ../..
            fi
          fi
          
          # Build todos os componentes
          for dir in packages/components/*/; do
            if [ -d "$dir" ] && [ -f "$dir/package.json" ]; then
              package_name=$(grep -o '"name": "[^"]*"' "$dir/package.json" | cut -d'"' -f4)
              if [[ "$package_name" == @nubrell/* ]]; then
                echo "Building $package_name..."
                cd "$dir"
                yarn build
                cd ../../..
              fi
            fi
          done
          
          echo "âœ… All packages built!"

      - name: Publish to GitHub Packages
        working-directory: lib-verniz-starter
        run: |
          echo "Publishing @nubrell packages to GitHub Packages..."
          
          # FunÃ§Ã£o para verificar e publicar um package
          publish_package() {
            local package_dir=$1
            local package_name=$(grep -o '"name": "[^"]*"' "$package_dir/package.json" | cut -d'"' -f4)
            
            # SÃ³ publica se comeÃ§ar com @nubrell
            if [[ "$package_name" != @nubrell/* ]]; then
              echo "â­ï¸  Skipping $package_name (not a @nubrell package)"
              return 0
            fi
            
            # Verifica se tem build gerado
            if [ ! -f "$package_dir/dist/index.cjs" ] && [ ! -f "$package_dir/dist/index.mjs" ]; then
              echo "â­ï¸  Skipping $package_name (no build files found)"
              return 0
            fi
            
            echo "ðŸ“¦ Publishing $package_name..."
            cd "$package_dir"
            
            # Tenta publicar
            if npm publish --access restricted; then
              echo "âœ… Successfully published $package_name"
            else
              exit_code=$?
              if [ $exit_code -eq 1 ]; then
                echo "âš ï¸  $package_name already published or version exists (continuing...)"
              else
                echo "âŒ Failed to publish $package_name"
                exit $exit_code
              fi
            fi
            cd - > /dev/null
          }
          
          # Publicar utils primeiro (se for @nubrell/utils)
          if [ -d "packages/utils" ] && [ -f "packages/utils/package.json" ]; then
            publish_package "packages/utils"
          fi
          
          # Publicar todos os componentes
          for dir in packages/components/*/; do
            if [ -d "$dir" ] && [ -f "$dir/package.json" ]; then
              publish_package "$dir"
            fi
          done
          
          echo "âœ¨ Finished publishing packages!"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
