name: Publish Packages

on:
  push:
    tags:
      - 'v*'  # Publica quando uma tag versÃ£o Ã© criada (ex: v1.0.0)
  workflow_dispatch: # Permite disparar manualmente

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish:
    name: Build and Publish Packages
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@nubrell'

      - name: Configure npm/yarn for GitHub Packages
        working-directory: lib-verniz-starter
        run: |
          # Cria .npmrc para yarn usar o token do GitHub Packages
          echo "@nubrell:registry=https://npm.pkg.github.com" >> .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> .npmrc

      - name: Install Dependencies
        working-directory: lib-verniz-starter
        run: |
          # Instala todas as dependÃªncias incluindo devDependencies
          yarn install --frozen-lockfile --production=false
          
          # Verifica se os pacotes Radix foram instalados
          echo "Checking Radix UI packages..."
          ls -la node_modules/@radix-ui/ || echo "Radix packages not found in root"
          
          # Verifica se os pacotes @nubrell foram instalados (workspace links)
          echo "Checking @nubrell packages..."
          ls -la node_modules/@nubrell/ || echo "@nubrell packages not found in root"
          
          # Garante que os pacotes estÃ£o disponÃ­veis
          yarn install --check-files

      - name: Build @nubrell Packages
        working-directory: lib-verniz-starter
        run: |
          echo "Building @nubrell packages..."
          
          # Adiciona node_modules/.bin ao PATH
          export PATH="$PWD/node_modules/.bin:$PATH"
          
          # FunÃ§Ã£o para fazer build de um pacote
          build_package() {
            local package_dir=$1
            local package_name=$(grep -o '"name": "[^"]*"' "$package_dir/package.json" | cut -d'"' -f4)
            
            if [[ "$package_name" != @nubrell/* ]]; then
              return 0
            fi
            
            echo "Building $package_name..."
            
            # Usa yarn workspace para fazer o build (usa os workspace links locais)
            # Isso evita tentar baixar do GitHub Packages durante o build
            yarn workspace "$package_name" build || (
              # Fallback: tenta fazer build direto no diretÃ³rio
              cd "$package_dir"
              yarn build || npx tsup
              cd - > /dev/null
            )
          }
          
          # Build utils
          if [ -d "packages/utils" ] && [ -f "packages/utils/package.json" ]; then
            build_package "packages/utils"
          fi
          
          # Build todos os componentes
          for dir in packages/components/*/; do
            if [ -d "$dir" ] && [ -f "$dir/package.json" ]; then
              build_package "$dir"
            fi
          done
          
          echo "âœ… All packages built!"

      - name: Publish to GitHub Packages
        working-directory: lib-verniz-starter
        run: |
          echo "Publishing @nubrell packages to GitHub Packages..."
          
          # FunÃ§Ã£o para verificar e publicar um package
          publish_package() {
            local package_dir=$1
            local package_name=$(grep -o '"name": "[^"]*"' "$package_dir/package.json" | cut -d'"' -f4)
            
            # SÃ³ publica se comeÃ§ar com @nubrell
            if [[ "$package_name" != @nubrell/* ]]; then
              echo "â­ï¸  Skipping $package_name (not a @nubrell package)"
              return 0
            fi
            
            # Verifica se tem build gerado
            if [ ! -f "$package_dir/dist/index.cjs" ] && [ ! -f "$package_dir/dist/index.mjs" ]; then
              echo "â­ï¸  Skipping $package_name (no build files found)"
              return 0
            fi
            
            echo "ðŸ“¦ Publishing $package_name..."
            cd "$package_dir"
            
            # Tenta publicar
            if npm publish --access restricted; then
              echo "âœ… Successfully published $package_name"
            else
              exit_code=$?
              if [ $exit_code -eq 1 ]; then
                echo "âš ï¸  $package_name already published or version exists (continuing...)"
              else
                echo "âŒ Failed to publish $package_name"
                exit $exit_code
              fi
            fi
            cd - > /dev/null
          }
          
          # Publicar utils primeiro (se for @nubrell/utils)
          if [ -d "packages/utils" ] && [ -f "packages/utils/package.json" ]; then
            publish_package "packages/utils"
          fi
          
          # Publicar todos os componentes
          for dir in packages/components/*/; do
            if [ -d "$dir" ] && [ -f "$dir/package.json" ]; then
              publish_package "$dir"
            fi
          done
          
          echo "âœ¨ Finished publishing packages!"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
