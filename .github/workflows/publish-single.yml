name: Publish Single Package

on:
  push:
    tags:
      - "nubrell/*@*" # Publica quando uma tag de componente Ã© criada (ex: nubrell/button@0.0.1)
  workflow_dispatch:
    inputs:
      package_path:
        description: "Caminho do package (ex: packages/components/button)"
        required: false
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish:
    name: Publish Single Package
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Precisamos do histÃ³rico completo para tags

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          registry-url: "https://npm.pkg.github.com"
          scope: "@nubrell"

      - name: Extract package info from tag
        id: package-info
        run: |
          if [[ "${{ github.ref }}" == refs/tags/nubrell/*@* ]]; then
            # Tag format: nubrell/button@0.0.1
            TAG_NAME="${GITHUB_REF#refs/tags/}"
            COMPONENT_NAME=$(echo "$TAG_NAME" | cut -d'/' -f2 | cut -d'@' -f1)
            VERSION=$(echo "$TAG_NAME" | cut -d'@' -f2)
            PACKAGE_NAME="@nubrell/$COMPONENT_NAME"
            
            # Determine package path
            if [ "$COMPONENT_NAME" == "utils" ]; then
              PACKAGE_PATH="packages/utils"
            else
              PACKAGE_PATH="packages/components/$COMPONENT_NAME"
            fi
            
            echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
            echo "package_path=$PACKAGE_PATH" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "component_name=$COMPONENT_NAME" >> $GITHUB_OUTPUT
          elif [ -n "${{ github.event.inputs.package_path }}" ]; then
            # Manual dispatch with package_path
            # Remove 'lib-verniz-starter/' prefix if present
            INPUT_PATH="${{ github.event.inputs.package_path }}"
            if [[ "$INPUT_PATH" == lib-verniz-starter/* ]]; then
              PACKAGE_PATH="${INPUT_PATH#lib-verniz-starter/}"
            else
              PACKAGE_PATH="$INPUT_PATH"
            fi
            
            # Read package.json (relative to lib-verniz-starter)
            FULL_PATH="lib-verniz-starter/$PACKAGE_PATH"
            if [ ! -f "$FULL_PATH/package.json" ]; then
              echo "âŒ Error: package.json not found at $FULL_PATH/package.json"
              exit 1
            fi
            
            PACKAGE_NAME=$(grep -o '"name": "[^"]*"' "$FULL_PATH/package.json" | cut -d'"' -f4)
            VERSION=$(grep -o '"version": "[^"]*"' "$FULL_PATH/package.json" | cut -d'"' -f4)
            
            echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
            echo "package_path=$PACKAGE_PATH" >> $GITHUB_OUTPUT
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          else
            echo "âŒ Error: No tag or package_path provided"
            exit 1
          fi

      - name: Configure npm/yarn for GitHub Packages
        working-directory: lib-verniz-starter
        run: |
          # Cria .npmrc para yarn usar o token do GitHub Packages
          echo "@nubrell:registry=https://npm.pkg.github.com" >> .npmrc
          echo "//npm.pkg.github.com/:_authToken=${{ secrets.GITHUB_TOKEN }}" >> .npmrc

      - name: Install Dependencies
        working-directory: lib-verniz-starter
        run: |
          yarn install --frozen-lockfile
          # Garante que todas as devDependencies estÃ£o instaladas
          yarn install --production=false

          # Verifica se os workspace links foram criados
          echo "Checking workspace links..."
          ls -la node_modules/@nubrell/ || echo "âš ï¸  @nubrell packages not found in root node_modules"

          # Lista os links criados
          if [ -d "node_modules/@nubrell" ]; then
            echo "âœ… Workspace links found:"
            ls -la node_modules/@nubrell/
          fi

          # Garante que os pacotes estÃ£o linkados corretamente
          yarn install --check-files

      - name: Update package version from tag
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        working-directory: lib-verniz-starter
        run: |
          cd "${{ steps.package-info.outputs.package_path }}"
          CURRENT_VERSION=$(grep -o '"version": "[^"]*"' package.json | cut -d'"' -f4)
          TARGET_VERSION="${{ steps.package-info.outputs.version }}"

          if [ "$CURRENT_VERSION" != "$TARGET_VERSION" ]; then
            echo "Updating version from $CURRENT_VERSION to $TARGET_VERSION"
            npm version "$TARGET_VERSION" --no-git-tag-version
            echo "âœ… Updated version to $TARGET_VERSION"
          else
            echo "Version already set to $TARGET_VERSION, skipping update"
          fi

      - name: Build Package
        working-directory: lib-verniz-starter
        run: |
          PACKAGE_PATH="${{ steps.package-info.outputs.package_path }}"
          PACKAGE_NAME="${{ steps.package-info.outputs.package_name }}"

          if [[ "$PACKAGE_NAME" != @nubrell/* ]]; then
            echo "âŒ Error: Only @nubrell packages can be published via this workflow."
            exit 1
          fi

          echo "Building $PACKAGE_NAME..."

          # Adiciona node_modules/.bin ao PATH
          export PATH="$PWD/node_modules/.bin:$PATH"

          # Para o nav, precisamos garantir que os workspace links estejam disponÃ­veis
          # Cria links simbÃ³licos se necessÃ¡rio
          if [[ "$PACKAGE_NAME" == "@nubrell/nav" ]]; then
            echo "Setting up workspace links for nav dependencies..."
            cd "$PACKAGE_PATH"
            
            # Cria node_modules se nÃ£o existir
            mkdir -p node_modules/@nubrell
            
            # Cria links simbÃ³licos para os pacotes dependentes
            if [ ! -L "node_modules/@nubrell/badge" ] && [ -d "../../../node_modules/@nubrell/badge" ]; then
              ln -s ../../../../node_modules/@nubrell/badge node_modules/@nubrell/badge
            fi
            if [ ! -L "node_modules/@nubrell/collapsible" ] && [ -d "../../../node_modules/@nubrell/collapsible" ]; then
              ln -s ../../../../node_modules/@nubrell/collapsible node_modules/@nubrell/collapsible
            fi
            if [ ! -L "node_modules/@nubrell/dropdown-menu" ] && [ -d "../../../node_modules/@nubrell/dropdown-menu" ]; then
              ln -s ../../../../node_modules/@nubrell/dropdown-menu node_modules/@nubrell/dropdown-menu
            fi
            
            cd - > /dev/null
          fi

          # Tenta fazer build direto no diretÃ³rio (nÃ£o usa yarn workspace para evitar problemas)
          cd "$PACKAGE_PATH"
          yarn build || npx tsup

          # Verifica se o build foi bem-sucedido
          if [ ! -f "dist/index.cjs" ] && [ ! -f "dist/index.mjs" ]; then
            echo "âŒ Error: Build failed - no output files found"
            exit 1
          fi

          echo "âœ… Build successful!"

      - name: Publish Package
        working-directory: lib-verniz-starter
        run: |
          PACKAGE_PATH="${{ steps.package-info.outputs.package_path }}"
          PACKAGE_NAME="${{ steps.package-info.outputs.package_name }}"

          echo "ðŸ“¦ Publishing $PACKAGE_NAME..."
          cd "$PACKAGE_PATH"

          if npm publish --access restricted; then
            echo "âœ… Successfully published $PACKAGE_NAME"
          else
            exit_code=$?
            if [ $exit_code -eq 1 ]; then
              echo "âš ï¸  $PACKAGE_NAME already published or version exists"
              exit 1
            else
              echo "âŒ Failed to publish $PACKAGE_NAME"
              exit $exit_code
            fi
          fi
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create Git Tag (if not exists)
        if: success() && github.event_name == 'workflow_dispatch'
        continue-on-error: true
        run: |
          PACKAGE_NAME="${{ steps.package-info.outputs.package_name }}"
          VERSION="${{ steps.package-info.outputs.version }}"
          # Extract component name from package name (e.g., @nubrell/menu -> menu)
          COMPONENT_NAME="${PACKAGE_NAME#@nubrell/}"
          TAG_NAME="nubrell/${COMPONENT_NAME}@${VERSION}"

          # Check if tag already exists
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME already exists, skipping"
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG_NAME" -m "Release $PACKAGE_NAME@$VERSION" || echo "Failed to create tag (non-critical)"
          git push origin "$TAG_NAME" || echo "Failed to push tag (non-critical)"
